extends layout

block content
    script(src="../javascripts/lib.js")

    .content
      .container
        .page-header
          h3 Упражнения на выборку
        .row-fluid
          .span4.debug
            .ex-question.debug
                h4 упражнение #: #{excercise.id}
                p #{excercise.question}
            .ex-help.debug
                h4 для справки:
                ul
                    - for(var i=0;i<excercise.helps.length;++i) {
                        - var help=excercise.helps[i];
                        li
                            a(href='../help/#{excercise.helps[i]}') #{chapters[excercise.helps[i]].title}
                    - }
          .span8.debug
            .ex-query
                h5 query window
                .query-inner.debug
                    textarea#query-area #{config.defaultExcerciseTextAreaContent}
        .row-fluid.debug
          .span6.debug
            h4 Правильный ответ:
            //svg#correct_svg.debug
          .span6.debug
            h4 Результат выполнения запроса:
            svg#result_svg.debug
            textarea#result_json(autofocus)

    script(type='text/javascript').
      var queryArea, resultSvg, resultDiv;
      var graph = Morph.Graph.graph();
      var svg = document.getElementById('result_svg')
      var renderer = Morph.Graph.View.renderer(graph, {
                  container: svg,
                  nodeSize: 30,
                  nodeColor: '#8abc4e',
                  linkColor: '#f00'
                });

      function formatJSONString(inp){
        return inp//.replace("{","<p>{").replace("}","}</p>");
      }

      function sendQuery(){
          console.log(queryArea.val());
          $.post( "../ex-check", { query: queryArea.val()})
            .done(function( data ) {
              console.log( "Data Loaded: ", data );
              resultDiv.val(JSON.stringify(data,null,4));
              graph.clear();
              graph.fromJSON(data.results);
              renderer.run();
              //graph.log();
            });
      }

      $(document).ready(function () {
        queryArea=$('#query-area');
        resultSvg=$('#result_svg');
        resultDiv=$('#result_json');


        $('#query-area').keydown(function (e) {

          if (e.ctrlKey && e.keyCode == 13) {
            // Ctrl-Enter pressed
            sendQuery();
          }
        });
        queryArea.focus();
      });